<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="report_financial">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.internal_layout">
                    <t t-set="report_landscape" t-value="data.get('enable_report_T') and data['account_report_id'][1] in ['Balance Sheet', 'Neraca']"/>
                    <div class="page" t-att-style="'page-break-inside: avoid;' if report_landscape else ''">
                        <style>
                            .table-t-format {
                                border-collapse: collapse;
                                width: 100%;
                            }
                            .table-t-format thead th {
                                border-left: 1px solid white !important;
                                border-right: 1px solid white !important;
                                border-top: 1px solid #dee2e6;
                                border-bottom: 2px solid #dee2e6;
                                padding: 8px;
                                background-color: #f8f9fa;
                            }
                            .table-t-format tbody tr {
                                border-left: 1px solid white !important;
                                border-right: 1px solid white !important;
                                border-bottom: 1px solid #dee2e6;
                            }
                            .table-t-format tbody td {
                                border-left: 1px solid white !important;
                                border-right: 1px solid white !important;
                                padding: 6px 8px;
                                vertical-align: top;
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                            }
                            .t-format-container {
                                display: table;
                                width: 100%;
                                table-layout: fixed;
                            }
                            .t-format-column {
                                display: table-cell;
                                width: 50%;
                                vertical-align: top;
                                padding: 0 5px;
                            }
                            .t-format-row-sync {
                                display: table-row;
                            }
                        </style>
                        <h2 t-esc="data['account_report_id'][1]"/>

                        <div class="row mt32 mb32">
                            <div class="col-4">
                                <strong>Target Moves:</strong>
                                <p>
                                    <span t-if="data['target_move'] == 'all'">All Entries</span>
                                    <span t-if="data['target_move'] == 'posted'">All Posted Entries</span>
                                </p>
                            </div>
                            <div class="col-4">
                                <p>
                                    <t t-if="data['date_from']"><strong>Date from :</strong> <span t-esc="data['date_from']"/><br/></t>
                                    <t t-if="data['date_to']"><strong>Date to :</strong> <span t-esc="data['date_to']"/></t>
                                </p>
                            </div>
                        </div>

                        <!-- T-Format Balance Sheet (Horizontal) - Single Table with 4 Columns -->
                        <t t-if="data.get('enable_report_T') and data['account_report_id'][1] in ['Balance Sheet', 'Neraca']">
                            <t t-set="left_lines" t-value="[l for l in data['get_left_lines'](data) if l['level'] != 0]"/>
                            <t t-set="right_lines" t-value="[l for l in data['get_right_lines'](data) if l['level'] != 0]"/>
                            <t t-set="max_rows" t-value="max(len(left_lines), len(right_lines))"/>
                            
                            <!-- Calculate total for Assets (Aktiva) - first line with level 1 on left side -->
                            <t t-set="total_aktiva" t-value="0"/>
                            <t t-foreach="left_lines" t-as="line">
                                <t t-if="line.get('name') in ['Aktiva', 'AKTIVA', 'Assets', 'ASSETS', 'Asset', 'ASSET'] or (int(line.get('level', 0)) == 1 and total_aktiva == 0)">
                                    <t t-set="total_aktiva" t-value="abs(line.get('balance', 0))"/>
                                </t>
                            </t>
                            
                            <!-- Calculate total for Liabilities (Hutang dan Modal) - first line with level 1 on right side -->
                            <t t-set="total_pasiva" t-value="0"/>
                            <t t-foreach="right_lines" t-as="line">
                                <t t-if="line.get('name') in ['Hutang dan Modal', 'HUTANG DAN MODAL', 'Liabilities', 'LIABILITIES', 'Kewajiban', 'KEWAJIBAN', 'Pasiva', 'PASIVA'] or (int(line.get('level', 0)) == 1 and total_pasiva == 0)">
                                    <t t-set="total_pasiva" t-value="abs(line.get('balance', 0))"/>
                                </t>
                            </t>
                            
                            <table class="table table-sm table-t-format" style="table-layout: fixed; width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 28%; border-right: 2px solid #dee2e6 !important;">Name (Assets)</th>
                                        <th class="text-end" style="width: 15%;">Balance</th>
                                        <th class="text-end" style="width: 7%; border-right: 3px solid #333 !important;">%</th>
                                        <th style="width: 28%; border-left: none !important;">Name (Liabilities)</th>
                                        <th class="text-end" style="width: 15%;">Balance</th>
                                        <th class="text-end" style="width: 7%;">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="range(max_rows)" t-as="idx">
                                        <tr>
                                            <!-- Left Side (Assets) -->
                                            <t t-if="idx &lt; len(left_lines)">
                                                <t t-set="a" t-value="left_lines[idx]"/>
                                                <t t-if="int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: normal;'"/></t>
                                                <t t-if="not int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: bold;'"/></t>
                                                <td style="border-right: 2px solid #dee2e6 !important;">
                                                    <span style="color: white;" t-esc="'..' * int(a.get('level', 0))"/>
                                                    <span t-att-style="style" t-esc="a.get('name')"/>
                                                </td>
                                                <td class="text-end" style="white-space: nowrap;">
                                                    <span t-att-style="style" t-esc="a.get('balance')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                                </td>
                                                <td class="text-end" style="white-space: nowrap; border-right: 3px solid #333 !important;">
                                                    <t t-if="total_aktiva and a.get('balance', 0) != 0">
                                                        <span t-att-style="style" t-esc="'{:.1f}'.format(abs(a.get('balance', 0)) / total_aktiva * 100) + '%'"/>
                                                    </t>
                                                </td>
                                            </t>
                                            <t t-else="">
                                                <td style="border-right: 2px solid #dee2e6 !important;">&#160;</td>
                                                <td>&#160;</td>
                                                <td style="border-right: 3px solid #333 !important;">&#160;</td>
                                            </t>
                                            
                                            <!-- Right Side (Liabilities) -->
                                            <t t-if="idx &lt; len(right_lines)">
                                                <t t-set="b" t-value="right_lines[idx]"/>
                                                <t t-if="int(b.get('level')) &gt; 3"><t t-set="style_r" t-value="'font-weight: normal;'"/></t>
                                                <t t-if="not int(b.get('level')) &gt; 3"><t t-set="style_r" t-value="'font-weight: bold;'"/></t>
                                                <td>
                                                    <span style="color: white;" t-esc="'..' * int(b.get('level', 0))"/>
                                                    <span t-att-style="style_r" t-esc="b.get('name')"/>
                                                </td>
                                                <td class="text-end" style="white-space: nowrap;">
                                                    <span t-att-style="style_r" t-esc="b.get('balance')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                                </td>
                                                <td class="text-end" style="white-space: nowrap;">
                                                    <t t-if="total_pasiva and b.get('balance', 0) != 0">
                                                        <span t-att-style="style_r" t-esc="'{:.1f}'.format(abs(b.get('balance', 0)) / total_pasiva * 100) + '%'"/>
                                                    </t>
                                                </td>
                                            </t>
                                            <t t-else="">
                                                <td>&#160;</td>
                                                <td>&#160;</td>
                                                <td>&#160;</td>
                                            </t>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>

                        <!-- Standard Format (Not T-Format) -->
                        <t t-if="not data.get('enable_report_T') or data['account_report_id'][1] not in ['Balance Sheet', 'Neraca']">
                            
                            <!-- Calculate total for percentage - capture Aktiva or first level 1 item -->
                            <t t-set="total_parent" t-value="0"/>
                            <t t-foreach="get_account_lines" t-as="line">
                                <t t-if="line.get('name') in ['Aktiva', 'AKTIVA', 'Assets', 'ASSETS', 'Pendapatan', 'PENDAPATAN', 'Revenue', 'REVENUE'] or (int(line.get('level', 0)) == 1 and total_parent == 0)">
                                    <t t-set="total_parent" t-value="abs(line.get('balance', 0))"/>
                                </t>
                            </t>
                            
                            <table class="table table-sm table-reports" t-if="data['debit_credit'] == 1">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="text-end">Debit</th>
                                    <th class="text-end">Credit</th>
                                    <th class="text-end">Balance</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="get_account_lines" t-as="a">
                                    <t t-if="a['level'] != 0">
                                        <t t-if="int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: normal;'"/></t>
                                        <t t-if="not int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: bold;'"/></t>

                                        <td>
                                            <span style="color: white;" t-esc="'..' * int(a.get('level', 0))"/>
                                            <span t-att-style="style" t-esc="a.get('name')"/>
                                        </td>
                                        <td class="text-end" style="white-space: text-nowrap;">
                                            <span t-att-style="style" t-esc="a.get('debit')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                        </td>
                                        <td class="text-end" style="white-space: text-nowrap;">
                                            <span t-att-style="style" t-esc="a.get('credit')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                        </td>
                                        <td class="text-end" style="white-space: text-nowrap;">
                                            <span t-att-style="style" t-esc="a.get('balance')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                        </td>
                                        <td class="text-end" style="white-space: text-nowrap;">
                                            <t t-if="total_parent and a.get('balance', 0) != 0">
                                                <span t-att-style="style" t-esc="'{:.1f}'.format(abs(a.get('balance', 0)) / total_parent * 100) + '%'"/>
                                            </t>
                                        </td>
                                    </t>
                                </tr>
                            </tbody>
                        </table>

                        <table class="table table-sm table-reports" t-if="not data['enable_filter'] and not data['debit_credit']">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="text-end">Balance</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="get_account_lines" t-as="a">
                                    <t t-if="a['level'] != 0">
                                        <t t-if="int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: normal;'"/></t>
                                        <t t-if="not int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: bold;'"/></t>

                                        <td>
                                            <span style="color: white;" t-esc="'..' * int(a.get('level', 0))"/>
                                            <span t-att-style="style" t-esc="a.get('name')"/>
                                        </td>
                                        <td class="text-end"><span t-att-style="style" t-esc="a.get('balance')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/></td>
                                        <td class="text-end">
                                            <t t-if="total_parent and a.get('balance', 0) != 0">
                                                <span t-att-style="style" t-esc="'{:.1f}'.format(abs(a.get('balance', 0)) / total_parent * 100) + '%'"/>
                                            </t>
                                        </td>
                                    </t>
                                </tr>
                            </tbody>
                        </table>

                        <table class="table table-sm table-reports" t-if="data['enable_filter'] == 1 and not data['debit_credit']">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="text-end">Balance</th>
                                    <th class="text-end"><span t-esc="data['label_filter']"/></th>
                                    <th class="text-end">Net Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="get_account_lines" t-as="a">
                                    <t t-if="a['level'] != 0">
                                        <t t-if="int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: normal;'"/></t>
                                        <t t-if="not int(a.get('level')) &gt; 3"><t t-set="style" t-value="'font-weight: bold;'"/></t>
                                        <td>
                                            <span style="color: white;" t-esc="'..'"/>
                                            <span t-att-style="style" t-esc="a.get('name')"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-att-style="style" t-esc="a.get('balance')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-att-style="style" t-esc="a.get('balance_cmp')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-att-style="style" t-esc="a.get('net_change')" t-options="{'widget': 'monetary', 'display_currency': res_company.currency_id}"/>
                                        </td>
                                    </t>
                                </tr>
                            </tbody>
                        </table>
                        </t>
                        <!-- End Standard Format -->
                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>
